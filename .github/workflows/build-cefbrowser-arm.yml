name: Build cefbrowser armhf

on:
  workflow_dispatch:

permissions: write-all

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: install dependencies
        shell: bash
        run: |
          sudo apt update
          sudo apt install -y git make cmake libssl-dev openssl curl pip ninja-build           
          pip3 install --user meson

      - name: Install Cross-Compile Support
        uses: cyberjunk/gha-ubuntu-cross@v2
        with:
          arch: armhf

      - name: Install target system packages
        shell: bash
        run: |
          sudo apt install -y zlib1g-dev:armhf libssl-dev:armhf libcrypt-dev:armhf libglib2.0-dev:armhf libnss3-dev:armhf \
                  libatk1.0-dev:armhf libatk-bridge2.0-dev:armhf libcups2-dev:armhf libxcomposite-dev:armhf libxdamage-dev:armhf \
                  libxrandr-dev:armhf libgbm-dev:armhf libxkbcommon-dev:armhf libpango1.0-dev:armhf libasound2-dev:armhf

      - name: git clone
        shell: bash
        run: |
          git clone --depth 1 https://github.com/Zabrimus/cefbrowser.git

      - name: build
        shell: bash
        run: |
          export PATH=~/.local/bin/:$PATH
          cd cefbrowser
          ./setup.sh arm
          PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig meson setup build --cross-file xcompile/meson-cross-file-debian-arm.conf -Darch=arm -Dstrip=true
          echo "cd into build directory"          
          cd build
          meson compile 
          meson install --skip-subprojects
          CREV=$(cd .. && git rev-parse --short HEAD)
          mv Release cefbrowser-armhf-${CREV}
          tar -czf cefbrowser-armhf-${CREV}.tar.gz cefbrowser-armhf-${CREV} 
          ls -la

      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"

      - uses: oprypin/find-latest-tag@v1
        with:
          repository:  Zabrimus/Workflows
          releases-only: false
        id: current_release_tag

      - name: Release
        run: |
          TAG="${{ steps.date.outputs.date }}"
          
          cd cefbrowser/build
          gh release create "$TAG" -R Zabrimus/Workflows || true
          gh release upload "$TAG" cefbrowser*.tar.gz --clobber -R Zabrimus/Workflows
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOWRUNNER }}
